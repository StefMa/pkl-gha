amends "package://pkg.pkl-lang.org/github.com/stefma/pkl-gha/com.github.action@0.0.4#/GitHubAction.pkl"
import "modules/Steps.pkl"

name = "GeneratePklDoc"

on {
  push {
    branches {
      "main"
    }
  }
}

jobs {
  ["generateDocsAndPush"] {
    `runs-on` = new UbuntuLatest {}
    permissions {
      contents = "write"
    }
    steps {
      (Steps.checkout()) {
        with {
          ["fetch-depth"] = 0
        }
      }
      new {
        name = "Setup worktree for docs"
        run = """
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git worktree add tmp-docs docs
          """
      }
      new {
        name = "Install jbang"
        run = """
        curl -Ls https://sh.jbang.dev | bash -s - app setup
        echo "$HOME/.jbang/bin" >> $GITHUB_PATH
        """
      }
      new {
        name = "Generate pkl doc"
        run = "jbang run --main org.pkl.doc.Main \"org.pkl-lang:pkl-doc:0.26.3\"  *.pkl actinos/*.pkl -o tmp-docs"
      }
      new {
        name = "Update docs in docs branch and push"
        `working-directory` = "tmp-docs"
        run = """
          git add .
          git commit --amend -m "Docs for pkl-gha"
          git push --force origin docs
          """
      }
      new {
        name = "Upload artifact for GitHub Pages"
        uses = "actions/upload-pages-artifact@v3"
        with {
          ["path"] = "tmp-docs"
        }
      }
    }
  }
  ["deployToGitHubPages"] {
    `runs-on` = new UbuntuLatest {}
    needs = "generateDocsAndPush"
    permissions {
      pages = "write"
      `id-token` = "write"
    }
    environment {
      name = "gh-pages"
      url = "${{ steps.deployment.outputs.page_url }}"
    }
    steps {
      new {
        name = "Deploy to GitHub Pages"
        id = "deployment"
        uses = "actions/deploy-pages@v4"
      }
    }
  }
}